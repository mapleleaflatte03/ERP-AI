<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERPX AI Accounting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" v-cloak>
        <!-- Header -->
        <header class="bg-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    <h1 class="text-xl font-bold">ERPX AI Accounting</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm opacity-75">DO Agent qwen3-32b</span>
                    <div :class="['w-3 h-3 rounded-full', healthStatus === 'healthy' ? 'bg-green-400' : 'bg-red-400']"></div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Upload Section -->
            <section class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    Upload H√≥a ƒê∆°n
                </h2>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors"
                     :class="{'border-blue-400 bg-blue-50': isDragging}"
                     @dragover.prevent="isDragging = true"
                     @dragleave="isDragging = false"
                     @drop.prevent="handleDrop">
                    
                    <input type="file" ref="fileInput" @change="handleFileSelect" accept=".pdf,.png,.jpg,.jpeg,.xlsx" class="hidden">
                    
                    <div v-if="!uploading && !currentJob">
                        <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-gray-600 mb-2">K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c</p>
                        <button @click="$refs.fileInput.click()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            Ch·ªçn File
                        </button>
                        <p class="text-sm text-gray-400 mt-2">H·ªó tr·ª£: PDF, PNG, JPG, XLSX (t·ªëi ƒëa 50MB)</p>
                    </div>
                    
                    <div v-else-if="uploading" class="py-4">
                        <div class="animate-spin w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p class="text-gray-600">ƒêang t·∫£i l√™n...</p>
                    </div>
                    
                    <div v-else-if="currentJob" class="py-4">
                        <div v-if="currentJob.status === 'processing'" class="animate-pulse">
                            <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4 animate-spin"></div>
                            <p class="text-blue-600 font-medium">ƒêang x·ª≠ l√Ω v·ªõi AI...</p>
                            <p class="text-sm text-gray-500 mt-1">Job ID: {{ currentJob.job_id.slice(0, 8) }}...</p>
                        </div>
                        <div v-else-if="currentJob.status === 'completed'" class="text-green-600">
                            <svg class="w-10 h-10 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="font-medium">X·ª≠ l√Ω th√†nh c√¥ng!</p>
                        </div>
                        <div v-else-if="currentJob.status === 'failed'" class="text-red-600">
                            <svg class="w-10 h-10 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="font-medium">L·ªói x·ª≠ l√Ω</p>
                            <p class="text-sm mt-1">{{ currentJob.error }}</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Result Section -->
            <section v-if="currentJob && currentJob.result" class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    K·∫øt Qu·∫£ Ph√¢n T√≠ch
                </h2>
                
                <!-- Document Info -->
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-500">Lo·∫°i ch·ª©ng t·ª´</p>
                        <p class="font-semibold">{{ formatDocType(currentJob.result.doc_type) }}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-500">Nh√† cung c·∫•p</p>
                        <p class="font-semibold">{{ currentJob.result.vendor || 'N/A' }}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-500">S·ªë h√≥a ƒë∆°n</p>
                        <p class="font-semibold">{{ currentJob.result.invoice_no || 'N/A' }}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-500">ƒê·ªô tin c·∫≠y</p>
                        <p class="font-semibold" :class="currentJob.result.confidence >= 0.8 ? 'text-green-600' : 'text-yellow-600'">
                            {{ (currentJob.result.confidence * 100).toFixed(0) }}%
                        </p>
                    </div>
                </div>

                <!-- Amounts -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg flex-1 min-w-[200px]">
                        <p class="text-sm text-blue-600">T·ªïng ti·ªÅn</p>
                        <p class="text-2xl font-bold text-blue-700">{{ formatCurrency(currentJob.result.total_amount) }}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg flex-1 min-w-[200px]">
                        <p class="text-sm text-green-600">Thu·∫ø VAT</p>
                        <p class="text-2xl font-bold text-green-700">{{ formatCurrency(currentJob.result.vat_amount) }}</p>
                    </div>
                </div>

                <!-- Journal Entries -->
                <div class="mb-6">
                    <h3 class="font-semibold mb-3">üìù B√∫t to√°n ƒë·ªÅ xu·∫•t</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left">T√†i kho·∫£n</th>
                                    <th class="px-4 py-2 text-left">T√™n t√†i kho·∫£n</th>
                                    <th class="px-4 py-2 text-right">N·ª£</th>
                                    <th class="px-4 py-2 text-right">C√≥</th>
                                    <th class="px-4 py-2 text-left">Di·ªÖn gi·∫£i</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(entry, idx) in currentJob.result.entries" :key="idx" class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-2 font-mono">{{ entry.account_code }}</td>
                                    <td class="px-4 py-2">{{ entry.account_name }}</td>
                                    <td class="px-4 py-2 text-right font-mono">{{ entry.debit ? formatCurrency(entry.debit) : '-' }}</td>
                                    <td class="px-4 py-2 text-right font-mono">{{ entry.credit ? formatCurrency(entry.credit) : '-' }}</td>
                                    <td class="px-4 py-2 text-gray-600">{{ entry.description }}</td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-gray-100 font-semibold">
                                <tr>
                                    <td colspan="2" class="px-4 py-2">T·ªïng c·ªông</td>
                                    <td class="px-4 py-2 text-right font-mono">{{ formatCurrency(totalDebit) }}</td>
                                    <td class="px-4 py-2 text-right font-mono">{{ formatCurrency(totalCredit) }}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Explanation -->
                <div v-if="currentJob.result.explanation" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                    <p class="text-sm text-yellow-800">
                        <strong>Gi·∫£i th√≠ch AI:</strong> {{ currentJob.result.explanation }}
                    </p>
                </div>

                <!-- Risks -->
                <div v-if="currentJob.result.risks && currentJob.result.risks.length" class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
                    <p class="font-semibold text-red-800 mb-2">‚ö†Ô∏è C·∫£nh b√°o:</p>
                    <ul class="list-disc list-inside text-sm text-red-700">
                        <li v-for="risk in currentJob.result.risks" :key="risk">{{ risk }}</li>
                    </ul>
                </div>

                <!-- Actions -->
                <div class="flex gap-4" v-if="currentJob.status === 'completed'">
                    <button @click="approveJob(true)" 
                            class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Duy·ªát & Ghi S·ªï
                    </button>
                    <button @click="approveJob(false)"
                            class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        T·ª´ Ch·ªëi
                    </button>
                    <button @click="resetUpload"
                            class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors">
                        Upload m·ªõi
                    </button>
                </div>
            </section>

            <!-- Recent Jobs -->
            <section class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold mb-4 flex items-center justify-between">
                    <span class="flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        C√¥ng Vi·ªác G·∫ßn ƒê√¢y
                    </span>
                    <button @click="loadJobs" class="text-sm text-blue-500 hover:text-blue-700">L√†m m·ªõi</button>
                </h2>
                
                <div v-if="jobs.length === 0" class="text-center py-8 text-gray-500">
                    Ch∆∞a c√≥ c√¥ng vi·ªác n√†o
                </div>
                
                <div v-else class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left">Job ID</th>
                                <th class="px-4 py-2 text-left">File</th>
                                <th class="px-4 py-2 text-left">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-2 text-left">Lo·∫°i</th>
                                <th class="px-4 py-2 text-right">S·ªë ti·ªÅn</th>
                                <th class="px-4 py-2 text-left">Th·ªùi gian</th>
                                <th class="px-4 py-2"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="job in jobs" :key="job.job_id" class="border-b hover:bg-gray-50 cursor-pointer" @click="selectJob(job)">
                                <td class="px-4 py-2 font-mono text-xs">{{ job.job_id.slice(0, 8) }}...</td>
                                <td class="px-4 py-2">{{ job.file_info?.filename?.slice(0, 20) || 'N/A' }}</td>
                                <td class="px-4 py-2">
                                    <span :class="getStatusClass(job.status)" class="px-2 py-1 rounded-full text-xs">
                                        {{ getStatusText(job.status) }}
                                    </span>
                                </td>
                                <td class="px-4 py-2">{{ job.result?.doc_type || '-' }}</td>
                                <td class="px-4 py-2 text-right font-mono">{{ job.result?.total_amount ? formatCurrency(job.result.total_amount) : '-' }}</td>
                                <td class="px-4 py-2 text-xs text-gray-500">{{ formatDate(job.created_at) }}</td>
                                <td class="px-4 py-2">
                                    <button class="text-blue-500 hover:text-blue-700">Xem</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white text-center py-4 mt-8">
            <p class="text-sm">ERPX AI Accounting ¬© 2024 | Powered by DO Agent qwen3-32b</p>
        </footer>

        <!-- Toast Notification -->
        <div v-if="toast" 
             :class="['fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transition-all', toast.type === 'success' ? 'bg-green-500' : 'bg-red-500', 'text-white']">
            {{ toast.message }}
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        const API_BASE = window.location.origin.includes('localhost') ? 'http://localhost:8000' : '';

        createApp({
            setup() {
                const healthStatus = ref('unknown');
                const uploading = ref(false);
                const isDragging = ref(false);
                const currentJob = ref(null);
                const jobs = ref([]);
                const toast = ref(null);
                let pollInterval = null;

                const totalDebit = computed(() => {
                    if (!currentJob.value?.result?.entries) return 0;
                    return currentJob.value.result.entries.reduce((sum, e) => sum + (e.debit || 0), 0);
                });

                const totalCredit = computed(() => {
                    if (!currentJob.value?.result?.entries) return 0;
                    return currentJob.value.result.entries.reduce((sum, e) => sum + (e.credit || 0), 0);
                });

                const checkHealth = async () => {
                    try {
                        const res = await axios.get(`${API_BASE}/health`);
                        healthStatus.value = res.data.status;
                    } catch {
                        healthStatus.value = 'unhealthy';
                    }
                };

                const loadJobs = async () => {
                    try {
                        const res = await axios.get(`${API_BASE}/v1/jobs?limit=20`);
                        jobs.value = res.data.jobs || [];
                    } catch (e) {
                        console.error('Failed to load jobs:', e);
                    }
                };

                const handleFileSelect = (event) => {
                    const file = event.target.files[0];
                    if (file) uploadFile(file);
                };

                const handleDrop = (event) => {
                    isDragging.value = false;
                    const file = event.dataTransfer.files[0];
                    if (file) uploadFile(file);
                };

                const uploadFile = async (file) => {
                    uploading.value = true;
                    currentJob.value = null;

                    try {
                        const formData = new FormData();
                        formData.append('file', file);

                        const res = await axios.post(`${API_BASE}/v1/upload`, formData, {
                            headers: { 'Content-Type': 'multipart/form-data' }
                        });

                        currentJob.value = { job_id: res.data.job_id, status: 'processing' };
                        startPolling(res.data.job_id);
                        showToast('ƒê√£ upload th√†nh c√¥ng!', 'success');
                    } catch (e) {
                        showToast('L·ªói upload: ' + (e.response?.data?.detail || e.message), 'error');
                    } finally {
                        uploading.value = false;
                    }
                };

                const startPolling = (jobId) => {
                    if (pollInterval) clearInterval(pollInterval);
                    
                    pollInterval = setInterval(async () => {
                        try {
                            const res = await axios.get(`${API_BASE}/v1/jobs/${jobId}`);
                            currentJob.value = res.data;
                            
                            if (['completed', 'failed', 'approved', 'rejected'].includes(res.data.status)) {
                                clearInterval(pollInterval);
                                loadJobs();
                            }
                        } catch (e) {
                            console.error('Polling error:', e);
                        }
                    }, 2000);
                };

                const approveJob = async (approved) => {
                    if (!currentJob.value) return;
                    
                    try {
                        await axios.post(`${API_BASE}/v1/approve/${currentJob.value.job_id}`, {
                            approved,
                            notes: '',
                            approver_id: 'web-user'
                        });
                        
                        currentJob.value.status = approved ? 'approved' : 'rejected';
                        showToast(approved ? 'ƒê√£ duy·ªát th√†nh c√¥ng!' : 'ƒê√£ t·ª´ ch·ªëi', 'success');
                        loadJobs();
                    } catch (e) {
                        showToast('L·ªói: ' + (e.response?.data?.detail || e.message), 'error');
                    }
                };

                const selectJob = async (job) => {
                    try {
                        const res = await axios.get(`${API_BASE}/v1/jobs/${job.job_id}`);
                        currentJob.value = res.data;
                    } catch (e) {
                        showToast('L·ªói t·∫£i job', 'error');
                    }
                };

                const resetUpload = () => {
                    currentJob.value = null;
                    if (pollInterval) clearInterval(pollInterval);
                };

                const showToast = (message, type) => {
                    toast.value = { message, type };
                    setTimeout(() => toast.value = null, 3000);
                };

                const formatCurrency = (value) => {
                    if (!value) return '0';
                    return new Intl.NumberFormat('vi-VN').format(value) + ' ‚Ç´';
                };

                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleString('vi-VN');
                };

                const formatDocType = (type) => {
                    const types = {
                        'purchase_invoice': 'H√≥a ƒë∆°n mua',
                        'sales_invoice': 'H√≥a ƒë∆°n b√°n',
                        'expense': 'Chi ph√≠',
                        'receipt': 'Phi·∫øu thu/chi',
                        'other': 'Kh√°c'
                    };
                    return types[type] || type;
                };

                const getStatusClass = (status) => {
                    const classes = {
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'processing': 'bg-blue-100 text-blue-800',
                        'completed': 'bg-green-100 text-green-800',
                        'failed': 'bg-red-100 text-red-800',
                        'approved': 'bg-green-100 text-green-800',
                        'rejected': 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                };

                const getStatusText = (status) => {
                    const texts = {
                        'pending': 'Ch·ªù x·ª≠ l√Ω',
                        'processing': 'ƒêang x·ª≠ l√Ω',
                        'completed': 'Ho√†n th√†nh',
                        'failed': 'L·ªói',
                        'approved': 'ƒê√£ duy·ªát',
                        'rejected': 'T·ª´ ch·ªëi'
                    };
                    return texts[status] || status;
                };

                onMounted(() => {
                    checkHealth();
                    loadJobs();
                    setInterval(checkHealth, 30000);
                });

                return {
                    healthStatus,
                    uploading,
                    isDragging,
                    currentJob,
                    jobs,
                    toast,
                    totalDebit,
                    totalCredit,
                    handleFileSelect,
                    handleDrop,
                    approveJob,
                    selectJob,
                    resetUpload,
                    loadJobs,
                    formatCurrency,
                    formatDate,
                    formatDocType,
                    getStatusClass,
                    getStatusText
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
